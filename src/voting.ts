import {
    Message,
    EmbedBuilder,
    ButtonBuilder,
    ButtonStyle,
    ActionRowBuilder,
    Interaction,
} from "discord.js";
import { Database } from "sqlite3";
import { logHistory } from "./history";

// ‚úÖ Define structure type explicitly
type Structure = {
    id: number;
    name: string;
};

// ‚úÖ Starts a new voting session, now per-server
export async function startVoting(
    message: Message,
    players: string[],
    db: Database,
    guildId: string
) {
    db.run(
        "INSERT INTO adventure (guild_id) VALUES (?)",
        [guildId],
        function (err) {
            if (err) {
                return message.reply("‚ùå Database error.");
            }

            const adventureId = this.lastID;

            db.all(
                "SELECT id, name FROM structures WHERE guild_id = ?",
                [guildId],
                (err, structures: Structure[]) => {
                    if (err || structures.length === 0) {
                        return message.reply("‚ùå No structures exist.");
                    }

                    const structureList = structures
                        .map((s: Structure, i: number) => `${i + 1}. ${s.name}`)
                        .join("\n");

                    players.forEach(async (playerId) => {
                        const player = await message.client.users.fetch(playerId);
                        if (!player) return;

                        const embed = new EmbedBuilder()
                            .setTitle("üèõ Structure Voting")
                            .setDescription(
                                `Click a number to vote:\n\n${structureList}`,
                            )
                            .setColor(0x3498db);

                        const buttons = structures.map((s: Structure, i: number) =>
                            new ButtonBuilder()
                                .setCustomId(`vote_${adventureId}_${playerId}_${s.id}_${guildId}`)
                                .setLabel(`${i + 1}`)
                                .setStyle(ButtonStyle.Primary),
                        );

                        const actionRow =
                            new ActionRowBuilder<ButtonBuilder>().addComponents(
                                buttons,
                            );

                        await player.send({
                            embeds: [embed],
                            components: [actionRow],
                        });
                    });

                    message.reply("üì® Sent voting messages!");
                    logHistory(
                        db,
                        "Voting Started",
                        `Voting started for adventure ${adventureId} with players: ${players.join(", ")}`,
                        message.author.tag,
                        guildId
                    );
                },
            );
        }
    );
}

// ‚úÖ Handles votes when players click a button
export async function handleVote(
    interaction: Interaction,
    db: Database
) {
    if (!interaction.isButton()) return;

    console.log(
        `üó≥Ô∏è Vote button clicked: ${interaction.customId} by ${interaction.user.tag} in ${interaction.guild?.name}`,
    );

    // ‚úÖ Immediately acknowledge the interaction
    await interaction.deferReply({ ephemeral: true });

    // ‚úÖ Extract values from button ID
    const idParts = interaction.customId.split("_");

    if (idParts.length < 5) {
        console.error("‚ùå Missing guild ID in vote button!");
        return interaction.followUp({ content: "‚ùå Error: Missing server information.", ephemeral: true });
    }

    const [_, adventureId, userId, structureId, guildId] = idParts;

    // ‚úÖ Handle votes that originated from DMs
    const finalGuildId = guildId === "dm" ? null : guildId;

    if (!guildId) {
        console.error("‚ùå Guild ID missing from vote button!");
        return interaction.followUp({ content: "‚ùå Error: Missing server information.", ephemeral: true });
    }

    console.log(
        `Extracted IDs -> Adventure: ${adventureId}, User: ${userId}, Structure: ${structureId}`,
    );

    if (!adventureId || !userId || !structureId) {
        console.error("‚ùå Invalid button ID format:", interaction.customId);
        return interaction.followUp({
            content: "‚ùå Invalid vote button.",
            ephemeral: true,
        });
    }

    if (interaction.user.id !== userId) {
        console.warn(
            `‚ö†Ô∏è User ${interaction.user.tag} tried to vote but is not allowed.`,
        );
        return interaction.followUp({
            content: "‚ùå You are not allowed to vote in this session.",
            ephemeral: true,
        });
    }

    // ‚úÖ Check if user has already voted in this adventure
    db.get(
        "SELECT structure_id FROM votes WHERE user_id = ? AND adventure_id = ? AND guild_id = ?",
        [userId, adventureId, guildId],
        (err, row) => {
            if (err) {
                console.error("‚ùå Database error:", err);
                return interaction.followUp({
                    content: "‚ùå Database error.",
                    ephemeral: true,
                });
            }

            if (row) {
                console.log(
                    `üîÑ Updating vote for ${interaction.user.tag}: ${structureId}`,
                );
                db.run(
                    "UPDATE votes SET structure_id = ? WHERE user_id = ? AND adventure_id = ? AND guild_id = ?",
                    [structureId, userId, adventureId, guildId], // ‚úÖ Filter by `guild_id`
                    (err) => {
                        if (err) {
                            console.error("‚ùå Error updating vote:", err);
                            return interaction.followUp({
                                content: "‚ùå Error updating vote.",
                                ephemeral: true,
                            });
                        }

                        console.log(
                            "‚úÖ Vote successfully updated in the database.",
                        );

                        db.get<{ name: string }>(
                            "SELECT name FROM structures WHERE id = ? AND guild_id = ?",
                            [structureId, guildId],
                            (err, row) => {
                                if (err || !row) {
                                    console.error(
                                        "‚ùå Error fetching structure name:",
                                        err,
                                    );
                                    return interaction.followUp({
                                        content:
                                            "‚ùå Could not find structure name.",
                                        ephemeral: true,
                                    });
                                }

                                logHistory(
                                    db,
                                    "Vote Updated",
                                    `${interaction.user.tag} changed vote to ${row.name} in adventure ${adventureId}`,
                                    interaction.user.tag,
                                    guildId
                                );

                                interaction.followUp({
                                    content: `üîÑ Vote changed to **${row.name}**!`,
                                    ephemeral: true,
                                });
                            },
                        );
                    },
                );
            } else {
                console.log(
                    `‚úÖ Registering new vote for ${interaction.user.tag}: ${structureId}`,
                );

                db.run(
                    "INSERT INTO votes (user_id, structure_id, adventure_id, guild_id) VALUES (?, ?, ?, ?)",
                    [userId, structureId, adventureId, guildId],
                    (err) => {
                        if (err) {
                            console.error("‚ùå Error registering vote:", err);
                            return interaction.followUp({
                                content: "‚ùå Error registering vote.",
                                ephemeral: true,
                            });
                        }

                        console.log(
                            "‚úÖ Vote successfully inserted into the database.",
                        );

                        db.get<{ name: string }>(
                            "SELECT name FROM structures WHERE id = ? AND guild_id = ?",
                            [structureId, guildId],
                            (err, row) => {
                                if (err || !row) {
                                    console.error(
                                        "‚ùå Error fetching structure name:",
                                        err,
                                    );
                                    return interaction.followUp({
                                        content:
                                            "‚ùå Could not find structure name.",
                                        ephemeral: true,
                                    });
                                }

                                logHistory(
                                    db,
                                    "Vote Registered",
                                    `${interaction.user.tag} voted for ${row.name} in adventure ${adventureId}`,
                                    interaction.user.tag,
                                    guildId
                                );

                                interaction.followUp({
                                    content: `‚úÖ Vote registered for **${row.name}**!`,
                                    ephemeral: true,
                                });
                            },
                        );
                    },
                );
            }
        },
    );
}
